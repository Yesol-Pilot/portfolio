
import { execSync } from 'child_process';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const OUTPUT_PATH = path.join(__dirname, '../src/data/history_auto.js');

try {
    // 1. Get detailed git logs (Hash | Date | Message)
    const gitLog = execSync('git log -n 20 --pretty=format:"%h|%ad|%s" --date=short').toString();

    // 2. Formatting Rules
    const TYPE_MAP = {
        'feat': 'âœ¨ ê¸°ëŠ¥ êµ¬í˜„',
        'fix': 'ðŸ”§ ìˆ˜ì •',
        'docs': 'ðŸ“ ë¬¸ì„œ',
        'style': 'ðŸŽ¨ ìŠ¤íƒ€ì¼',
        'refactor': 'â™»ï¸ êµ¬ì¡° ê°œì„ ',
        'perf': 'ðŸš€ ì„±ëŠ¥ ìµœì í™”',
        'test': 'âœ… í…ŒìŠ¤íŠ¸',
        'chore': 'âš™ï¸ ì‹œìŠ¤í…œ',
        'revert': 'âª ë¡¤ë°±'
    };

    const IGNORE_PATTERNS = [
        'merge branch',
        'wip',
        'typo'
    ];

    const formatMessage = (msg) => {
        // Common Dictionary for automatic translation
        const DICT = {
            'remove': 'ì œê±°', 'delete': 'ì‚­ì œ', 'fix': 'ìˆ˜ì •', 'resolve': 'í•´ê²°',
            'implement': 'êµ¬í˜„', 'add': 'ì¶”ê°€', 'update': 'ì—…ë°ì´íŠ¸', 'refine': 'ë‹¤ë“¬ê¸°',
            'refactor': 'êµ¬ì¡° ê°œì„ ', 'chore': 'ê´€ë¦¬', 'feat': 'ê¸°ëŠ¥',
            'audio': 'ì˜¤ë””ì˜¤', 'system': 'ì‹œìŠ¤í…œ', 'sound': 'ì‚¬ìš´ë“œ', 'hud': 'UI',
            'naming': 'ì´ë¦„', 'philosophy': 'ê¸°íš ì² í•™', 'autoselection': 'ìžë™ ì„ íƒ',
            'logic': 'ë¡œì§', 'safety': 'ì•ˆì „ìž¥ì¹˜', 'crash': 'ì¶©ëŒ', 'optimization': 'ìµœì í™”',
            'performance': 'ì„±ëŠ¥', 'deploy': 'ë°°í¬', 'artifacts': 'ì‚°ì¶œë¬¼',
            'merge': 'ë³‘í•©', 'branch': 'ë¸Œëžœì¹˜', 'sensitive': 'ë³´ì•ˆ', 'files': 'íŒŒì¼',
            'scene': 'ì”¬', 'transition': 'ì „í™˜', 'immersion': 'ëª°ìž…ê°', 'solar': 'íƒœì–‘ê³„',
            'constellation': 'ë³„ìžë¦¬', 'component': 'ì»´í¬ë„ŒíŠ¸', 'click': 'í´ë¦­',
            'autoplay': 'ìžë™ìž¬ìƒ', 'mute': 'ìŒì†Œê±°', 'log': 'ë¡œê·¸', 'visualization': 'ì‹œê°í™”'
        };

        let processedMsg = msg;

        // 1. Prefix Removal ([feat], feat: etc)
        const match = msg.match(/^\[?(\w+)\]?[:\s]\s*(.*)/i);
        let type = 'update';
        let content = msg;

        if (match) {
            type = match[1].toLowerCase();
            content = match[2];
        }

        // 2. Content Translation (Simple Replace)
        Object.keys(DICT).forEach(key => {
            const regex = new RegExp(key, 'gi'); // Case insensitive
            content = content.replace(regex, DICT[key]);
        });

        // 3. Type Formatting
        if (TYPE_MAP[type]) {
            return `${TYPE_MAP[type]}: ${content}`;
        }

        // Fallback for unknown types
        return `ðŸ› ï¸ ì—…ë°ì´íŠ¸: ${content}`;
    };

    // 3. Process Commits
    const changes = gitLog.split('\n')
        .filter(Boolean)
        .map(line => {
            const [hash, date, message] = line.split('|');
            return { hash, date, message };
        })
        .filter(commit => {
            // Filter redundant chore commits if needed, or keeping them minimal
            const lowerMsg = commit.message.toLowerCase();
            if (IGNORE_PATTERNS.some(p => lowerMsg.includes(p))) return false;
            // Only show significant updates
            return true;
        })
        .map(commit => formatMessage(commit.message))
        .slice(0, 10); // Limit to 10 meaningful items

    const autoEntry = {
        version: "Recent Dev Stream",
        date: new Date().toISOString().split('T')[0],
        title: "DEVELOPER LOG (LIVE)",
        changes: changes.length > 0 ? changes : ["No recent notable changes."]
    };

    const content = `// This file is auto-generated by scripts/generate-history.js
export const autoHistory = [
    ${JSON.stringify(autoEntry, null, 4)}
];
`;

    fs.writeFileSync(OUTPUT_PATH, content);
    console.log(`[Success] Generated history_auto.js with ${changes.length} items.`);

} catch (error) {
    console.warn("[Warning] Git history generation failed. Using empty fallback.");
    const fallbackContent = `export const autoHistory = [];`;
    fs.writeFileSync(OUTPUT_PATH, fallbackContent);
}
